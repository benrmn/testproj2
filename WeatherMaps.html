<!DOCTYPE HTML>
<html>

<head>

    <title>Weather Maps</title>
    <link rel="stylesheet" href="WeatherMaps.css">
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<script type="text/javascript" async defer src="https://maps.googleapis.com/maps/api/js?key=REPLACE_KEY&callback=initMap"></script>
	<style>
		.dirClass{
			height:400px;
			width:350px;
			margin-bottom: 10px;
			border:4px solid black;
			color: black;
			overflow:auto;
			float: left;
		}
		#map{
			height: 400px;
			width: 50%;
			margin-right: 20%;
			margin-left: 20%;
		}
	</style>

</head>


<body>

	<div class="header" id="example1">
	<span class="city"><p id="incity">College Station, TX</p></span>
	<span class="zipcode"><input type="text" id="zip" name="zipcode1" placeholder="Search Zip Code"></input><div class="text-error"></div></span>
	</div>

	
	<div class="topmap">
	<p id="linktext"><a id="link" href="https://www.google.com" target="_blank">Click Here</a> to view your route in a new tab</p>
	</div>
	
	<div id="map"></div>
	
	<div class="inputObjects">
	<input type="text" id="start" placeholder="Enter Start Location">
	<button id = "search" onclick="getLocations()">Search</button>
	<input type="text" id="end" placeholder="Enter Destination Location">
	</div>
	
	
</body>

<!-- Normal Script Functions -->
<script>

	var directionsService;
	var directionsDisplay;

	var map;
	var geoJSON;
	var request;
	var gettingData = false;
	var openWeatherMapKey = "9c99cfb44e61bd404e553beb5e630d04";
	var infowindow

	function initMap() {

		// Map Init Code
		directionsService = new google.maps.DirectionsService;
		directionsDisplay = new google.maps.DirectionsRenderer;
		infowindow = new google.maps.InfoWindow();

		map = new google.maps.Map(document.getElementById('map'), {
			zoom: 7,
			center: new google.maps.LatLng(30.601389,-96.314445)
		});
		directionsDisplay.setMap(map);

		var onChangeHandler = function() {
			calculateAndDisplayRoute(directionsService, directionsDisplay);
		};

		// Weather Init Code

		// Add interaction listeners to make weather requests
		google.maps.event.addListener(map, 'idle', checkIfDataRequested);

		// Sets up and populates the info window with details
		map.data.addListener('click', function(event){
			infowindow.setContent(
				"<img src=" + event.feature.getProperty("icon") + ">"
				+ "<br /><strong>" + event.feature.getProperty("city") + "</strong>"
				+ "<br />" + event.feature.getProperty("temperature") + "&deg;C"
				+ "<br />" + event.feature.getProperty("weather")
				);
			infowindow.setOptions({
				position:{
					lat: event.latLng.lat(),
					lng: event.latLng.lng()
				},
				pixelOffset: {
					width: 0,
					height: -15
				}
			});
			infowindow.open(map);
			});
	} //End of initialization

	function calculateAndDisplayRoute(directionsService, directionsDisplay) {
		directionsService.route({
		  origin: document.getElementById('start').value,
		  destination: document.getElementById('end').value,
		  travelMode: 'DRIVING'
		}, function(response, status) {
		  if (status === 'OK') {
			directionsDisplay.setDirections(response);
		  } else {
			window.alert('Directions request failed due to ' + status);
		  }
		});
	}

	function getLocations() {
		calculateAndDisplayRoute(directionsService, directionsDisplay);
	}

	// *** Weather Code ***
	var checkIfDataRequested = function() {
		// Stop extra requests being sent
		while (gettingData === true) {
		  request.abort();
		  gettingData = false;
		}
		getCoords();
	};

	// Get the coordinates from the Map bounds
	var getCoords = function() {
		var bounds = map.getBounds();
		var NE = bounds.getNorthEast();
		var SW = bounds.getSouthWest();
		getWeather(NE.lat(), NE.lng(), SW.lat(), SW.lng());
	};

	// Make the weather request
	var getWeather = function(northLat, eastLng, southLat, westLng) {
		gettingData = true;
		var requestString = "http://api.openweathermap.org/data/2.5/box/city?bbox="
							+ westLng + "," + northLat + "," //left top
							+ eastLng + "," + southLat + "," //right bottom
							+ map.getZoom()
							+ "&cluster=yes&format=json"
							+ "&APPID=" + openWeatherMapKey;
		request = new XMLHttpRequest();
		request.onload = proccessResults;
		request.open("get", requestString, true);
		request.send();
	};

	// Take the JSON results and proccess them
	var proccessResults = function() {
		console.log(this);
		var results = JSON.parse(this.responseText);
		if (results.list.length > 0) {
			resetData();
			for (var i = 0; i < results.list.length; i++) {
			  geoJSON.features.push(jsonToGeoJson(results.list[i]));
			}
			drawIcons(geoJSON);
		}
	};

	// For each result that comes back, convert the data to geoJSON
	var jsonToGeoJson = function (weatherItem) {
		var feature = {
		  type: "Feature",
		  properties: {
			city: weatherItem.name,
			weather: weatherItem.weather[0].main,
			temperature: weatherItem.main.temp,
			min: weatherItem.main.temp_min,
			max: weatherItem.main.temp_max,
			humidity: weatherItem.main.humidity,
			pressure: weatherItem.main.pressure,
			windSpeed: weatherItem.wind.speed,
			windDegrees: weatherItem.wind.deg,
			windGust: weatherItem.wind.gust,
			icon: "http://openweathermap.org/img/w/"
				  + weatherItem.weather[0].icon  + ".png",
			coordinates: [weatherItem.coord.Lon, weatherItem.coord.Lat]
		  },
		  geometry: {
			type: "Point",
			coordinates: [weatherItem.coord.Lon, weatherItem.coord.Lat]
		  }
		};

		// Set the custom marker icon
		map.data.setStyle(function(feature) {
			return {
				icon: {
				  url: feature.getProperty('icon'),
				  anchor: new google.maps.Point(25, 25)
				}
			  };
			});

			// returns object
			return feature;
	};

	// Add the markers to the map
	var drawIcons = function (weather) {
		 map.data.addGeoJson(geoJSON);
		 // Set the flag to finished
		 gettingData = false;
	};

	// Clear data layer and geoJSON
	var resetData = function () {
		geoJSON = {
		  type: "FeatureCollection",
		  features: []
		};
		map.data.forEach(function(feature) {
			map.data.remove(feature);
		});
	};
	//google.maps.event.addDomListener(window, 'load', initMap);
	  
	/*
	function genMap(origin, dest){
		var htmlReq = "https://www.google.com/maps/embed/v1/directions?key=AIzaSyCb1cNnqPON86Tr-KctC6Sm1wSpvWeqLU8&origin="+origin+"&destination="+dest;
		document.getElementById("link").href = htmlReq;
		alert(htmlReq);
		document.getElementById("genMap").src = htmlReq;
	}
	
	<!-- Generate Directions -->
	function displayDirections (origin, dest){
	
		const proxyurl = 'https://cors-anywhere.herokuapp.com/';
		const api_url = 'https://maps.googleapis.com/maps/api/directions/json?origin='+origin+'&destination='+dest+'&key=AIzaSyCb1cNnqPON86Tr-KctC6Sm1wSpvWeqLU8';
		var h = document.getElementById("steplist");
		
		async function getDirections(){
			
			const response = await fetch(proxyurl + api_url);
			const data = await response.json();
			
			
			//Get all direction steps from the route
			if(data["routes"] != undefined){
				var r;
				for(r = 0; r < data.routes.length; r++){
					var l;
					for(l = 0; l < data.routes[0].legs.length; l++){
						
						var st;
						for(st = 0; st < data.routes[0].legs[l].steps.length; st++){
							h.innerHTML+= (st+1).toString()+". " + data.routes[0].legs[l].steps[st].html_instructions + "<br>";
						}
					}	
				}				
			}
		}
        
        // Twitter functions
		function produce_url(){
			var startLocation = document.getElementById("origin").value;
			var endLocation = document.getElementById("dest").value;
			var startCity = startLocation.split(",")[1];
			var endCity = endLocation.split(",")[1];

		// I'll fix this, but this the token for now
		const needle = require('needle');
		const token = "AAAAAAAAAAAAAAAAAAAAADfgJAEAAAAA6xFb2NTV9W4pENarUXDaLsY1XuM%3Dq64CpklRlWzhJebR6oWtb5eOd0Ug33ZghjpXhjn5ouuMdBydk6"
		const endpointUrl = 'https://api.twitter.com/2/tweets/search/recent'

		async function get_tweet_Request() {

			// Edit query parameters below
			const params = {
				'query': 'from:NWS', 
				'tweet.fields': 'author_id' 
			} 

			const res = await needle('get', endpointUrl, params, { headers: {
				"authorization": `Bearer ${token}`
			}})

			if(res.body) {
				const response = res.body.data
                var tweet_url = "/315-Project-3/oembed.js?tweet=https://twitter.com/user/status/"+response[0].id;
                console.log(tweet_url)
				return tweet_url;
			} else {
				throw new Error ('Unsuccessful request')
			}
		}

		async function pull_tweets(){
            const tweet_url = await get_tweet_Request();
            console.log(tweet_url)
			// let newScriptTag = document.createElement("script", {src: tweet_url});
            // document.body.appendChild(newScriptTag);
            getElementById("tweet1").src=tweet_url;
		}

		}

	</script>


	<script type="text/javascript">
		$(function() {
			// IMPORTANT: Fill in your client key
			var clientKey = "js-Dr3iohlJPxZhAnCHYcD95XzvOBdp1zbAH6OquExSv3lgUexuMWQZlR1Fa5ueViiM";
			var cache = {};
			var container = $("#example1");
			var errorDiv = container.find("div.text-error");

			/* Handle successful response */
			function handleResp(data)
			{
				// Check for error
				if (data.error_msg)
					//document.getElementById("incity").innerHTML = "NO";
					errorDiv.text(data.error_msg);
				else if ("city" in data) {
					// Set city and state
					//container.find("input[name='city']").val(data.city);
					//container.find("input[name='state']").val(data.state);
					document.getElementById("incity").innerHTML = data.city+", "+data.state;
				}
			}
		}

		// Set up event handlers
		container.find("input[name='zipcode1']").on("keyup change", function() {
			// Get zip code
			var zipcode = $(this).val().substring(0, 5);
			if (zipcode.length == 5 && /^[0-9]+$/.test(zipcode)) {
				// Clear error
				errorDiv.empty();

				// Check cache
				if (zipcode in cache){
					handleResp(cache[zipcode]);
				}
				else {
					// Build url
					var url = "https://www.zipcodeapi.com/rest/"+clientKey+"/info.json/" + zipcode + "/radians";

					// Make AJAX request
					$.ajax({
						"url": url,
						"dataType": "json"
					}).done(function(data) {
						handleResp(data);

						// Store in cache
						cache[zipcode] = data;
					}).fail(function(data) {
						if (data.responseText && (json = $.parseJSON(data.responseText))) {
							// Store in cache
							cache[zipcode] = json;

							// Check for error
							if (json.error_msg)
								errorDiv.text(json.error_msg);
						}
						else
							errorDiv.text('Request failed.');
					});
				}
			}
		}).trigger("change");
	});
</script>

</html>
